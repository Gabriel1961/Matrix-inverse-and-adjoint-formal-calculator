<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=AM_CHTML"></script>
    <script src="algebrite.js"></script>
    <title>Matrice inversa</title>
</head>

<body>
    <div style="margin-bottom: 10px;">
        <label for="table-size">Marimea matricei: </label>
        <input id="table-size" type="number" min="1" max="10" value="3" required />
        <table id="matrix-input">

        </table>
    </div>

    <button style="margin-bottom: 20px;" id="calc-button">
        Calculeaza
    </button>
    <div style="transform: translate(25%) scale(150%);" class="ioarea" id="result-latex">
        <script type="math/asciimath" id="result-box">
        </script>
    </div>
    <script>

        function createMatrixInput(size) {
            let tb = document.getElementById("matrix-input")
            tb.innerHTML = ""
            for (let i = 0; i < size; i++) {
                let row = tb.insertRow();
                for (let j = 0; j < size; j++) {
                    let cell = row.insertCell()
                    let cin = document.createElement("input")
                    cin.value = +(i == j)
                    cell.appendChild(cin)
                }
            }
        }

        function parseMatrixInput() {
            let mat = []
            let rows = document.getElementById("matrix-input").querySelectorAll("tr");
            for (let i = 0; i < rows.length; i++) {
                let cells = rows[i].querySelectorAll("td");
                mat.push([])
                for (let j = 0; j < cells.length; j++) {
                    mat[i].push("(" + cells[j].childNodes[0].value + ")")
                }
            }
            return mat
        }

        function replaceSqrt(str) {
            while (true) {
                let pos = str.indexOf("^(1/2)")
                if (pos == -1)
                    break;
                if (str[pos - 1] == ')') {
                    let cnt = 1
                    let i = pos - 2
                    while (cnt != 0) {
                        if (str[i] == ')')
                            cnt++;
                        else if (str[i] == '(')
                            cnt--;
                        i--
                    }
                    i = Math.max(i, 0)
                    str = str.slice(0, i) + "sqrt" + str.slice(i, pos) + str.slice(pos + 6)
                }
                else {
                    let i = pos - 1
                    while (str[i - 1] >= '0' && str[i - 1] <= "9") {
                        i--
                        if (i == 0)
                            break;
                    }
                    str = str.slice(0, i) + "sqrt(" + str.slice(i, pos) + str.slice(pos + 5)
                }
            }
            return str
        }

        function calcDet(a) {
            let n = a.length
            if (n == 1) // 
                return a[0][0]
            let expr = "0"
            for (let j = 0; j < n; j++) { // pt fiecare minor
                let mn = []
                for (let i1 = 1; i1 < n; i1++) {
                    mn.push([]) // creeza o noua linie
                    for (let j1 = 0; j1 < n; j1++) { // pt fiecare coloana din minor 
                        if (j != j1) {
                            mn[i1 - 1].push(a[i1][j1]) // se copiaza din matricea initiala in minor
                        }
                    }
                }
                if (j % 2 == 0) // semnul in functie de paritatea lui j
                    expr += "+(" + calcDet(mn) + ")" + "*(-1)*" + a[0][j]
                else
                    expr += "+(" + calcDet(mn) + ")" + "*" + a[0][j]
            }
            return Algebrite.run(expr)
        }

        let tableSize = document.getElementById("table-size");
        tableSize.addEventListener("change", function () {
            createMatrixInput(parseInt(tableSize.value))
        })
        createMatrixInput(parseInt(tableSize.value))
        let calcBut = document.getElementById("calc-button")
        window.MathJax = {
            "fast-preview": {
                disabled: true
            },
            AuthorInit: function () {
                MathJax.Hub.Register.StartupHook('End', function () {
                    MathJax.Hub.processSectionDelay = 0
                    var mathSource = document.getElementById('result-box')
                    var math = MathJax.Hub.getAllJax("result-latex")[0]
                    calcBut.addEventListener('click', function () {
                        let mat = parseMatrixInput()
                        let res = calcDet(mat)
                        res = replaceSqrt(res)
                        MathJax.Hub.Queue(['Text', math, "det A =" + res])
                    })
                })
            }
        }
    </script>
</body>

</html>